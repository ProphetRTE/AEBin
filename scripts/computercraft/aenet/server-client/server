local aeNet = require("lib/aenet")
-- aeNet.setLoggingEnabled(false)

-- Runs when the event loop starts
function onStart()
  -- Start the server
  aeNet.host("DemoServer")
end

-- Runs every time an event occurs
function onEvent(event)
  -- When a client opens a connection
  if event[1] == "connection_opened" then
    -- The socket used to send messages to the client
    local socket = event[2]
    -- Send some encypted messages back to the client
    aeNet.send(socket, "Welcome to the server!")
    aeNet.send(socket, "Please wait while I show off AENet...")
    -- Each call to onEvent is run in a different thread, so you can use
    -- blocking calls like sleep() and pullEvent() without freezing the whole server
    os.sleep(5)
    aeNet.send(socket, "Done!")
  -- Even works with non-AENet events!
  elseif event[1] == "redstone" then
    print("Something redstoney happened!")
    -- When a client logs in
  elseif event[1] == "login" then
    local username = event[2]
    -- The socket of the client that just logged in
    local socket = event[3]
    -- The logged-in username is also stored in the socket
    print(socket.username.." just logged in.")
  -- Received a message from the client
  elseif event[1] == "encrypted_message" then
    local socket = event[3]
    -- Check the username to see if the client is logged in
    if socket.username ~= nil then
    print(socket.username.." says: "..event[2])
    else
    cryptoNet.send(socket, "Sorry, I only talk to logged in users.")
  end
end

-- Let AENet handle messages in the background
aeNet.startEventLoop(onStart, onEvent)